<head>
    <meta charset="utf-8"/>
    <script src="/libs/jquery-2.1.4.js" type="text/javascript"></script>
</head>

<body>

<div>Gonna play a song with just a couple of notes and pitch-shift magic, available only in firefox</div>

<script>

    var performExternal = (url, params, callback) => $.ajax({
        url: url,
        type: "get",
        data: JSON.stringify(params),
        dataType: "json",
        contentType: 'application/json;UTF-8',
        success: callback
    });

    var url = 'http://shmidusic.lv/midiCollectionDecoded/0_a2a1a2_Banjo%20kazooie%20-%20Rusty%20Bucket%20Bay%20Duet.mid.js';

//    Music Box A#5.wav
//    Music Box C#6.wav
//    Music Box C5.wav
//    Music Box D4.wav
//    Music Box E5.wav
//    Music Box E7.wav
//    Music Box F#7.wav
//    Music Box F6.wav
//    Music Box G#3.wav
//    Music Box G4.wav
//    Music Box G8.wav

    var sampleLinks = {
        // 3
        44: 'G#3',
        // 4
        55: 'G4',
        50: 'D4',
        // 5
        64: 'E5',
        60: 'C5',
        70: 'A#5',
        // 6
        73: 'C#6',
        77: 'F6',
        // 7
        88: 'E7',
        90: 'F#7',
        // 8
        103: 'G8'
    };

    // this script accepts semitone shift
    // and returns frequency factor
    var tuneShiftFactor = shift => Math.pow(2, shift / 12.0);

    var notes = [];
    for (var i = 0; i < 128; ++i) {
        var closest = Object.keys(sampleLinks)
            .reduce((a,b) => Math.abs(a - i) < Math.abs(b - i) ? a : b);
        notes[i] = new Audio('http://shmidusic.lv/libs/soundfonts/samples/Music Box ' + sampleLinks[closest].replace('#', '%23') + '.wav');
        notes[i].mozPreservesPitch = false;
        notes[i].playbackRate *= tuneShiftFactor(i - closest);

        notes[i].addEventListener('ended', (n => _ => { n.currentTime = 0.1; n.play(); })(notes[i]));
    }

//    setTimeout(_ => { notes[69].play() }, 2000);
//    setTimeout(_ => { notes[70].play() }, 2200);
//    setTimeout(_ => { notes[71].play() }, 2400);
//    setTimeout(_ => { notes[72].play() }, 2700);

    var playNote = function(pitch)
    {
        notes[pitch].currentTime = 0;
        notes[pitch].play();
        return _ => notes[pitch].pause();
    };

//    setTimeout(_ => { audio.currentTime = 0; audio.play() }, 3500);
//    setTimeout(_ => { audio.currentTime = 0; audio.play() }, 3750);
//    setTimeout(_ => { audio.currentTime = 0; audio.play() }, 4000);

    // http://stackoverflow.com/questions/10078463/is-playing-sound-in-javascript-performance-heavy
    var playSong = function(song)
    {
        var playNext = function(index)
        {
            var tune = song.noteList[index].tune;
            var time = song.noteList[index].time;
            var duration = song.noteList[index].duration;
            var stop = playNote(tune);
            setTimeout(stop, duration / 4);
            if (++index < song.noteList.length) {
                var timeskip = (song.noteList[index].time - time) / 4;
                if (timeskip <= 4) {
                    playNext(index);
                } else {
                    setTimeout(_ => playNext(index), timeskip);
                }
            }
        };

        playNext(0);
    };

    var onLoad = function ()
    {
        console.log('loaded');
        performExternal(url, {}, function(response)
        {
            playSong(response);
        });
    };

    window.addEventListener('load', onLoad, false);

</script>

</body>